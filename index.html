<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Monitor de Salas</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 20px; }
    h1 { text-align: center; }
    .salas { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .sala {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .status { font-size: 0.9em; color: gray; margin-top: 5px; }
    .usuarios { font-weight: bold; margin-top: 5px; }
    .resultados { margin-top: 10px; font-family: monospace; }
    button { margin-top: 5px; padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Monitor de Salas</h1>
  <div id="salas" class="salas"></div>

  <script>
    const ws = new WebSocket("ws://cassinoserver-production.up.railway.app/");
    //cassinoserver-production.up.railway.app/
    const salasDiv = document.getElementById("salas");

    const salasInfo = {}; // guarda info localmente
    let salaAtual = null;  // sala em que estamos atualmente

    ws.onopen = () => {
      console.log("Conectado ao servidor!");
      ws.send(JSON.stringify({ type: "getRooms" }));
    };

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);

      if (msg.type === "roomsList") {
        Object.keys(msg.data).forEach(tipo => {
          msg.data[tipo].forEach(room => {
            salasInfo[room] = { tipo, usuarios: 0, status: "Aguardando", history: [], joined: false };
            render();
          });
        });
      }

      if (msg.type === "status") {
        const { room, data } = msg;
        if (salasInfo[room]) {
          salasInfo[room].status = data;
          render();
        }
      }

      if (msg.type === "history") {
        const { room, data } = msg;
        if (salasInfo[room]) {
          salasInfo[room].history = data;
          render();
        }
      }

      if (msg.type === "roundResult") {
        const { room, data } = msg;
        if (salasInfo[room]) {
          salasInfo[room].history.push(data);
          if (salasInfo[room].history.length > 10) salasInfo[room].history.shift();
          render();
        }
      }

      if (msg.type === "userCount") {
        const { room, data } = msg;
        if (salasInfo[room]) {
          salasInfo[room].usuarios = data.count;
          render();
        }
      }
    };

    function joinSala(tipo, room) {
      // Sai da sala atual, se houver
      if (salaAtual && salaAtual !== room) {
        ws.send(JSON.stringify({ type: "exitRoom" }));
        salasInfo[salaAtual].joined = false;
      }

      // Entra na nova sala
      if (!salasInfo[room].joined) {
        ws.send(JSON.stringify({ type: "joinRoom", tipo, room }));
        salasInfo[room].joined = true;
        salaAtual = room;
      }

      render();
    }

    function render() {
      salasDiv.innerHTML = "";
      Object.keys(salasInfo).forEach(room => {
        const sala = salasInfo[room];

        salasDiv.innerHTML += `
          <div class="sala" id="sala-${room}">
            <h2>${sala.tipo.toUpperCase()} - ${room}</h2>
            <div class="status">Status: ${sala.status}</div>
            <div class="usuarios">UsuÃ¡rios: ${sala.usuarios}</div>
            <button onclick="joinSala('${sala.tipo}', '${room}')">
              ${sala.joined ? "Entrou" : "Entrar na Sala"}
            </button>
            <div class="resultados">HistÃ³rico: ${formatarHistorico(sala.tipo, sala.history)}</div>
          </div>
        `;
      });
    }

    function formatarHistorico(tipo, history) {
      if (!history.length) return "-";
      if (tipo.toLowerCase() === "roleta") return history.join(", ");
      if (tipo.toLowerCase() === "baccarat" || tipo.toLowerCase() === "footballstudio") {
        return history.map(r => Array.isArray(r) ? r.join(" ") : r).join(" | ");
      }
      if (tipo.toLowerCase() === "bacboo") {
        return history.map(r => Array.isArray(r) ? `ðŸŽ²${r[0]} ðŸŽ²${r[1]} vs ðŸŽ²${r[2]} ðŸŽ²${r[3]}` : r).join(" | ");
      }
      return history.join(", ");
    }
  </script>
</body>
</html>
