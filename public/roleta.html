<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Roleta</title>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="./js/roletaPlguin.js"></script>
  
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; }
    #status { font-weight: bold; }
    #error { color: red; margin-top: 10px; }
    #log { margin-top: 15px; padding: 10px; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; font-size: 14px; background: #f9f9f9; }
    ul { list-style: none; padding: 0; }
    li { padding: 5px 0; }
</style>
</head>
<body>
<h1>Roleta</h1>
<div id="tempo"></div>
<div>Status: <span id="status">Aguardando</span></div>

  <div class="">
    <canvas id="roulette" width="300" height="300" style="display: none;"></canvas>
  </div>
  
<div id="error"></div>
<div id="log"></div>
<div id="history"></div>

<script>
$(function() {
    
      $("#roulette").roulette({
      duration: 10000,
      wheelRotations: 6,
      ballRotations: 12,
      onFinish: function(num){
       // $('.table-container').css('display','block');
        $('#roulette').hide();//.css('display','none');
       // $("#roulette").width(100);
//$("#roulette").height(100);
        //alert("Parou no n√∫mero " + num);
      }
    });
  /*  setInterval(function(){
        $('.table-container').css('display','none');
        $('#roulette').css('display','block');
        
      const val = Math.round(Math.random()*37);
      console.log(val+'');
      $("#roulette").data("roulette").spin(val);
    },10000);*/
    
    
    
    const params = new URLSearchParams(window.location.search);
    const $roomName = params.get('room');
    const url = "https://cassinoserver-production.up.railway.app";
    const socket = io(url);

    const $history = $('#history');
    const $status = $('#status');
    const $error = $('#error');
    const $log = $('#log');
    const $tempo = $('#tempo');

    function log(msg) {
        $log.append(`<div>${msg}</div>`);
        $log.scrollTop($log[0].scrollHeight); // rola sempre pro final
    }

    // Recebe hist√≥rico completo da sala
    socket.on('history', data => {
        $history.empty();
        data.forEach(r => $history.append(`<b>${r.numero} </b>`));
        log("üìú Hist√≥rico carregado (" + data.length + " itens)");
    });

    // Recebe novos resultados
    socket.on('newResult', data => {
        const valor = data.numero;// Array.isArray(data.data) ? data.data.join(' ') : data.data;
        $history.append(`<b>${valor} </b>`);
        if ($history.children().length > 20) {
            $history.children().first().remove();
        }
        
     //   $("#roulette").data("roulette").spin(valor);
       // $("#roulette").show();
        
        log("üé≤ Novo resultado: " + valor);
    });
    
    socket.on('round', data => 
    {
        const valor = data.numero;// Array.isArray(data.data) ? data.data.join(' ') : data.data;
        $("#roulette").data("roulette").spin(valor);
        $("#roulette").show();
    });

    // Atualiza status da sala
    socket.on('status', data => {
        $status.text(data);
        log("‚ÑπÔ∏è Status: " +   data);
    });
    
    socket.on('tempo', data => {
    $tempo.text(data);
   // log("‚ÑπÔ∏è Status: " + data);
});

    // Exibe erros
    socket.on('error', data => {
        $error.text(data.error || 'Erro desconhecido');
        log("‚ùå Erro: " + (data.error || 'Erro desconhecido'));
    });

    // Eventos de conex√£o
    socket.on("connect", () => {
        $status.text("Conectado");
        socket.emit("joinRoom", $roomName);
        log("‚úÖ Conectado ao servidor (ID: " + socket.id + ")");
    });

    socket.on("connect_error", (err) => {
        $status.text("Erro");
        $error.text("Erro ao conectar: " + err.message);
        log("‚ùå Erro de conex√£o: " + err.message);
    });

    socket.on("reconnect_attempt", (attempt) => {
        $status.text("Reconectando...");
        log("üîÑ Tentando reconectar... tentativa #" + attempt);
    });

    socket.on("disconnect", (reason) => {
        $status.text("Desconectado");
        log("‚ö†Ô∏è Desconectado: " + reason);
    });
});
</script>
</body>
</html>
