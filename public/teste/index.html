<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Roleta com jQuery</title>
  <style>
    body {
      background: #2c2c2c;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 30px;
    }
    canvas {
      background: #006600;
      border-radius: 50%;
      box-shadow: 0 0 20px #000 inset;
    }
    select {
      margin-top: 20px;
      padding: 8px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>Roleta</h1>
  <canvas id="roulette" width="300" height="300"></canvas>
  <br>
  <select id="targetNumber"></select>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
  (function($){
    $.fn.roulette = function(options){
      const settings = $.extend({
        numbers: [
          '0','32','15','19','4','21','2','25','17','34','6','27','13','36','11','30',
          '8','23','10','5','24','16','33','1','20','14','31','9','22','18','29','7',
          '28','12','35','3','26'
        ],
        duration: 10000,        // tempo do giro (ms)
        wheelRotations: 5,      // voltas da roda
        ballRotations: 10,      // voltas da bolinha
        onFinish: null          // callback quando parar
      }, options);

      return this.each(function(){
        const canvas = this;
        const ctx = canvas.getContext("2d");
        const width = canvas.width;
        const height = canvas.height;
        const radius = width / 2;

        const numbers = settings.numbers;
        const numSlices = numbers.length;
        const sliceAngle = 2 * Math.PI / numSlices;

        let angle = -Math.PI/2;     // roleta
        let ballAngle = -Math.PI/2; // bolinha

        function drawWheel(){
          ctx.clearRect(0, 0, width, height);

          // slices
          for (let i = 0; i < numSlices; i++) {
            ctx.beginPath();
            ctx.moveTo(radius, radius);
            ctx.arc(radius, radius, radius, angle + i*sliceAngle, angle + (i+1)*sliceAngle);
            ctx.fillStyle = (i % 2 === 0) ? '#ff0000' : '#000000';
            if(numbers[i] === '0') ctx.fillStyle = '#00ff00';
            ctx.fill();
            ctx.stroke();

            // número
            ctx.save();
            ctx.translate(radius, radius);
            ctx.rotate(angle + (i + 0.5) * sliceAngle);
            ctx.textAlign = "right";
            ctx.fillStyle = "#fff";
            ctx.font = "bold 16px Arial";
            ctx.fillText(numbers[i], radius - 10, 5);
            ctx.restore();
          }

          // bolinha
          const ballRadius = 10;
          const ballX = radius + (radius - 15) * Math.cos(ballAngle);
          const ballY = radius + (radius - 15) * Math.sin(ballAngle);
          ctx.beginPath();
          ctx.arc(ballX, ballY, ballRadius, 0, 2*Math.PI);
          ctx.fillStyle = "#ffff00";
          ctx.fill();
          ctx.stroke();

          // círculo central externo
          const centerX = width / 2;
          const centerY = height / 2;
          const centerRadius = ((centerX+centerY)/2)*.7;
          ctx.beginPath();
          ctx.arc(centerX, centerY, centerRadius, 0, 2 * Math.PI);
          ctx.fillStyle = "#ffffff";
          ctx.fill();
          ctx.strokeStyle = "#000000";
          ctx.lineWidth = 2;
          ctx.stroke();

          // círculo central interno
          ctx.beginPath();
          ctx.arc(centerX, centerY, centerRadius*.25, 0, 2 * Math.PI);
          ctx.fillStyle = "#4F4F4F";
          ctx.fill();
          ctx.stroke();
        }

        function spinAnimated(target){
          const index = numbers.indexOf(target);
          const startAngle = angle;
          const startBallAngle = ballAngle;

          const finalAngle = -Math.PI/2; 
          const finalBallAngle = -Math.PI/2 + index * sliceAngle + sliceAngle / 2;

          const totalWheelRotation = settings.wheelRotations * 2 * Math.PI + (finalAngle - startAngle);
          const totalBallRotation = -settings.ballRotations * 2 * Math.PI + (finalBallAngle - startBallAngle);

          const startTime = performance.now();

          function animate(now){
            const elapsed = now - startTime;
            const t = Math.min(elapsed / settings.duration, 1);
            const easeOut = 1 - Math.pow(1 - t, 5);

            angle = startAngle + totalWheelRotation * easeOut;
            ballAngle = startBallAngle + totalBallRotation * easeOut;

            drawWheel();

            if (t < 1){
              requestAnimationFrame(animate);
            } else {
              angle = finalAngle;
              ballAngle = finalBallAngle;
              drawWheel();
              if(typeof settings.onFinish === "function"){
                settings.onFinish(target);
              }
            }
          }

          requestAnimationFrame(animate);
        }

        // desenha inicial
        drawWheel();

        // expõe API pública
        $(canvas).data("roulette", {
          spin: spinAnimated,
          draw: drawWheel,
          numbers: numbers
        });
      });
    };
  })(jQuery);

  // Inicialização
  $(function(){
    // inicializa plugin
    $("#roulette").roulette({
      duration: 3000,
      wheelRotations: 6,
      ballRotations: 12,
      onFinish: function(num){
      //alert("Parou no número " + num);
      }
    });

    // preenche select
    const api = $("#roulette").data("roulette");
    api.numbers.forEach(n=>{
      $("#targetNumber").append(new Option(n,n));
    });

    // evento select
    $("#targetNumber").on("change", function(){
      const val = $(this).val();
      $("#roulette").data("roulette").spin(val);
    });
  });
  </script>
</body>
</html>
